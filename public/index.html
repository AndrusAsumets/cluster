<html>
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1">
		<script type="text/javascript" src="/js/bower_components/pathfinding/pathfinding-browser.min.js"></script>
		<style>		
			html, body {
				margin: 0;
				padding: 0;
				width: 100vw;
				height: 100vh;
				background-color: white;
				overflow: hidden;
			}
			
			.controller {
				position: absolute;
				top: 0;
				right: 1vw;
				width: calc(100vw / 7 - 2vw);
				color: black;
				top: 50%;
				transform: translateY(-50%);
			}
			
			.elements {
				width: 100%;
				height: 100vh;
				display: flex;
				flex-direction: column;
				align-items: center;
				justify-content: center;
				//padding: 16vh 0;
			}
			
			.element {
				width: 100%;
				display: flex;
				align-items: center;
				justify-content: center;
				height: calc(100vh / 6);
				margin: 0.5vh 2vw;
				box-sizing: border-box;
				user-select: none;
				cursor: pointer;
				color: white;
				font-size: 1em;
				font-family: 'Helvetica Neue', 'sans';
			}
			
			.rock {
				background-color: red;
			}
			
			.paper {
				background-color: green;
			}
			
			.scissors {
				background-color: blue;
			}
			
			canvas:nth-child(1) {
				border-right: 1px solid black;	
			}
		</style
	</head>

	<body>
		<div class="game"></div>
		<div class="controller">
			<div class="elements">
				<div class="element rock">rock</div>
				<div class="element paper">paper</div>
				<div class="element scissors">scissors</div>
			</div>
		</div>
		
		<script>
			document.getElementsByClassName('rock')[0].addEventListener('click', function() { createElement('rock') })
			document.getElementsByClassName('paper')[0].addEventListener('click', function() { createElement('paper') })
			document.getElementsByClassName('scissors')[0].addEventListener('click', function() { createElement('scissors') })
			
			document.getElementsByClassName('rock')[0].addEventListener('touchstart', function() { createElement('rock') })	
			document.getElementsByClassName('paper')[0].addEventListener('touchstart', function() { createElement('paper') })
			document.getElementsByClassName('scissors')[0].addEventListener('click', function() { createElement('scissors') })
			
			var PIXEL_RATIO = (function () {
			    var ctx = document.createElement('canvas').getContext('2d'),
			        dpr = window.devicePixelRatio || 1,
			        bsr = ctx.webkitBackingStorePixelRatio ||
			              ctx.mozBackingStorePixelRatio ||
			              ctx.msBackingStorePixelRatio ||
			              ctx.oBackingStorePixelRatio ||
			              ctx.backingStorePixelRatio || 1
			
			    return dpr / bsr
			})()
			
			var iw = window.innerWidth - (window.innerWidth / 7)
			var ih = window.innerHeight
			var w = iw > ih ? iw : ih
			var h = ih < iw ? ih : iw
			
			var matrix = [
				[0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0],
				[0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 1, 0],
				[0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 1, 0],
				[0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 1, 0],
				[0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 1, 0],
				[0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 1, 0],
				[0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 1, 0],
				[0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 1, 0],
				[0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 1, 0],
				[0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 1, 0],
				[0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 1, 0],
				[0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 1, 0],
				[0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0]
			]
			
			var elements = []
			
			var shapes = {
				border: {
					fillStyle: 'black',
					strokeStyle: 'rgba(0, 0, 0, 0)'
				},
				path: {
					fillStyle: 'blue',
					strokeStyle: 'rgba(0, 0, 0, 0)'
				},
				rock: {
					fillStyle: 'red',
					strokeStyle: 'rgba(0, 0, 0, 0)'
				},
				paper: {
					fillStyle: 'green',
					strokeStyle: 'rgba(0, 0, 0, 0)'
				},
				scissors: {
					fillStyle: 'blue',
					strokeStyle: 'rgba(0, 0, 0, 0)'
				}
			}
			
			var step = 500
			var walk = true
			var time = (new Date).getTime()
			var added = false
			setInterval(function() {
				walk = true
				time = (new Date).getTime()
				added = false
			}, step)
			
			var grid = new PF.Grid(matrix)
			
			for (var i = 0; i < horizontal; i++) {
				for (var j = 0; j < vertical; j++) {
					if (matrix[j][i] == 0) grid.setWalkableAt(j, i, false)
				}
			}
			
			var finder = new PF.AStarFinder({
			    allowDiagonal: true
			})
			
			var ctx1 = createHiDPICanvas(w, h, 1)
			var ctx2 = createHiDPICanvas(w, h, 2)
			
			var horizontal = matrix[0].length
			var vertical = matrix.length
			for (var i = 0; i < horizontal; i++) { 
				line(ctx1, w / horizontal * i, 0, w / horizontal * i, h)
			}
			
			for (var i = 0; i < vertical; i++) {
				line(ctx1, 0, h / vertical * i, w, h / vertical * i)
			}
			
			//build scene
			for (var i = 0; i < horizontal; i++) {
				for (var j = 0; j < vertical; j++) {
					if (matrix[j][i] == 1) rect(ctx1, shapes.border, w / horizontal * i, h / vertical * j, w / horizontal, h / vertical)
					else if (matrix[j][i] > 1) {
						rect(ctx1, shapes.element, w / horizontal * i, h / vertical * j, w / horizontal, h / vertical)
					}
				}
			}
			
			function createElement(type) {
				if (added) return // allow just one element per step
				
				var start = [19, 0]
				var end = [0, 12]
				var element = {
					type: type,
					start: start,
					end: end,
					shapes: shapes[type],
					path: finder.findPath(start[0], start[1], end[0], end[1], grid.clone())
				}
				
				elements.push(element)
				
				var types = ['rock', 'paper', 'scissors']
				type = types[Math.floor(Math.random() * types.length)]
				start = [0, 12]
				end = [19, 0]
				element = {
					type: type,
					start: start,
					end: end,
					shapes: shapes[type],
					path: finder.findPath(start[0], start[1], end[0], end[1], grid.clone())
				}
				
				elements.push(element)
				added = true
			}
			
			for (var p = 0; p < elements.length; p++) {
				var element = elements[p]
				var path = finder.findPath(element.start[0], element.start[1], element.end[0], element.end[1], grid.clone())
				elements[p].path = path
				
				/*
				for (var n = 0; n < path.length; n++) {
					var i = path[n][0]
					var j = path[n][1]
					
					rect(ctx1, shapes.path, w / horizontal * i, h / vertical * j, w / horizontal, h / vertical)
				}
				*/
			}
			
			function animate() {
				requestAnimationFrame(animate)
				
				if (walk) {
					walk = false
					
					for (var p = 0; p < elements.length; p++) {
						var element = elements[p]

						if (element.path.length) {
							
							for (var r = 0; r < elements.length; r++) {
								if (r == p) continue //don't update the same object
								
								if (
									element.path.length &&
									elements[r].path.length &&
									elements[r].path[0][0] == element.path[0][0] &&
									elements[r].path[0][1] == element.path[0][1]
									
								) {
									if (!fight(element.type, elements[r].type)) {
										console.log('removed 1')
										elements[p].path = []
										continue
									}
									if (!fight(elements[r].type, element.type)) {
										console.log('removed 2')
										elements[r].path = []
										continue
									}
								}
							}

							if (!elements[p].removed) elements[p].path.shift()
						}
					}
				}
				
				ctx2.clearRect(0, 0, w, h)
				
				for (var p = 0; p < elements.length; p++) {
					var element = elements[p]
					
					if (
						element.path[1] &&
						element.path[1].length &&
						!elements[p].removed
					) {
						var x1 = element.path[0][0] * w / horizontal
						var y1 = element.path[0][1] * h / vertical
						var x2 = element.path[1][0] * w / horizontal
						var y2 = element.path[1][1] * h / vertical
						
						var dt = ((new Date).getTime() - time)
						var dx = x1 - (x1 - x2) * dt / step
						var dy = y1 - (y1 - y2) * dt / step
						
						rect(ctx2, element.shapes, dx, dy, w / horizontal, h / vertical)	
					}
						
				}
			}
			requestAnimationFrame(animate)
			
			function fight(a, b) {
				switch(a) {
				    case 'rock':
						if (b == 'paper') return false
				        break
				    case 'paper':
						if (b == 'scissors') return false
						break
				    case 'scissors':
						if (b == 'rock') return false
	
				}
				return true
			}
			
			function line(ctx, x1, y1, x2, y2) {
				ctx.beginPath()
				ctx.moveTo(x1, y1)
				ctx.lineTo(x2, y2)
				ctx.stroke()
			}
			
			function rect(ctx, shape, x1, y1, x2, y2) {
				ctx.beginPath()
				ctx.rect(x1, y1, x2, y2)
				ctx.fillStyle = shape.fillStyle
				ctx.fill()
				ctx.lineWidth = 7
				ctx.strokeStyle = shape.strokeStyle
				ctx.stroke()	
			}
			
			function createHiDPICanvas (w, h, z) {
			    ratio = PIXEL_RATIO
			    var can = document.createElement('canvas')
			    can.width = w * ratio
			    can.height = h * ratio
			    can.style.width = w + 'px'
			    can.style.height = h + 'px'
			    can.getContext('2d').setTransform(ratio, 0, 0, ratio, 0, 0)
				can.style.position = 'absolute'
				can.style.zIndex = z
				document.getElementsByClassName('game')[0].appendChild(can)
				return can.getContext('2d')
			}
		</script>
	</body>
</html>
